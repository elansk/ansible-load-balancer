#!/bin/sh

# This script checks whether a reload of haproxy was requested, regenerates its
# configuration file and reloads it.  The script is run via cron every minute.
# This ensures that haproxy is reloaded at most once a minute.

# Name of file that indicates haproxy needs to be reloaded.
HAPROXY_RELOAD_FILE="{{ LOAD_BALANCER_RELOAD_FILE }}"

if [ -f "$HAPROXY_RELOAD_FILE" -o "$1" = "-f" ]; then
    rm "$HAPROXY_RELOAD_FILE"
    {
        echo "# This file is auto-generated from the fragments in /etc/haproxy/conf.d."
        echo "# Don't edit it directly, since your changes will be overwritten."
        # Exclude editor backup files
        cat /etc/haproxy/conf.d/*[^~]
    } > /etc/haproxy/haproxy.cfg
    {
        echo "# This file is auto-generated from the fragments in /etc/haproxy/backends."
        echo "# Don't edit it directly, since your changes will be overwritten."
        # Exclude editor backup files
        cat /etc/haproxy/backends/*[^~]
    } > /etc/haproxy/backend.map
    systemctl reload haproxy
fi
